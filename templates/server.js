import{createServer as w}from"node:http";import{platform as d}from"node:os";import{watch as f,stat as m}from"node:fs";import{readdir as u,lstat as g}from"node:fs/promises";import{resolve as h}from"node:path";import{exec as p}from"node:child_process";var i=class{constructor(t,e){this.rootDir=t,this.res=e,this.processFileType=new Set(["scss","pug"])}#t(t){this.res.write(`data:${t}

`),t.endsWith("reload")&&console.log(t)}updateChangedFile(t,e){let s=t.split(".").pop();if(s==="html")return this.#t("tab-reload");if(this.rootDir==="/background")return this.#t("crx-reload");if(t==="content.js")return this.#t("crx&tab-reload");this.processFileType.has(s)&&this.#e(s,t),e?this.#t(`/${e}/${t}`):this.#t(h(this.rootDir,t))}#e(t,e){switch(t){case"scss":this.#s(e);break;case"pug":this.#o(e);break}}#s(t){p(`sass ${this.rootDir}/${t} ${this.rootDir.slice(1)}/style/${t.split(".")[0]}.css`)}#o(t){}};var r=d()==="linux",n=class{#t=new Set;constructor(t,e){this.rootDir=t,this.res=e,this.init(),this.refresh=new i(t,e)}async init(){this.#e(this.rootDir.slice(1)),r&&this.#s(this.rootDir.slice(1)),this.res.write(`data:\u26A1 hmr connected

`)}#e(t){let e=f(t,{recursive:!r},(s,o)=>{if(s==="rename")return this.checkRenameFile(t,o);r?this.filterChangeEvent(o,t):this.filterChangeEvent(o)});this.#t.add(e)}async filterChangeEvent(t,e){let s=r?e+"/"+t:this.getFullPath(t);m(s,(o,a)=>{a.size!==0&&this.refresh.updateChangedFile(t,e),console.log(`[${this.rootDir.slice(1)}]\x1B[32m page reload\x1B[30m "${t}`)})}async checkRenameFile(t,e){if(r)try{(await g(t+"/"+e)).isDirectory()&&this.#e(t+"/"+e)}catch(s){console.log(s)}}getFullPath(t){return t}#s=async t=>{let e=await u(t,{withFileTypes:!0});for(let s of e)if(s.isDirectory()){let o=`${t}/${s.name}`;this.#e(o),await this.#s(o)}};unwatchDir(){for(let t of this.#t)t.close()}};var l={"/background":"42","/scripts":"43","/options":"46","/popup":"33","/contents":"44"};async function x(c,t){let e=c.url,s=e.slice(1);console.info(`\x1B[${l[e]}m%s\x1B[0m`,s+" page connected "),console.info("\x1B[36m%s\x1B[0m","waiting for file change for "+s),t.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,OPTIONS","Access-Control-Allow-Private-Network":"true","Access-Control-Allow-Headers":"Cache-Control","Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),t.on("close",()=>{o.unwatchDir(),console.info("\x1B[41m%s\x1B[0m",`\u26A0\uFE0F ${s} page disconnected `)});let o=new n(e,t)}var C=()=>console.info("\x1B[32m%s\x1B[0m",`HMR ready at ${4500} port. Waiting for client`),b=w().listen(process.env.PORT||4500,C);b.on("request",x);
